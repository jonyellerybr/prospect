<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospec√ß√£o Inteligente - Fortaleza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 min-h-screen">
    <!-- Header -->
    <nav class="bg-white/95 backdrop-blur-sm shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-search-dollar text-purple-600 mr-2"></i>
                    Prospec√ß√£o Fortaleza
                </h1>
                <div class="flex gap-2">
                    <span id="status-badge" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                        <i class="fas fa-pause"></i> Parado
                    </span>
                    <button id="refresh-btn" class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition-colors" title="Atualizar dados">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Controls -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sliders text-purple-600 mr-2"></i>
                        Controles
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                N√∫mero de buscas
                            </label>
                            <input type="number" id="max-searches" value="10" min="1" max="50"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div class="flex gap-3">
                            <button id="start-btn" 
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition-all">
                                <i class="fas fa-play mr-2"></i>Iniciar Prospec√ß√£o
                            </button>
                            <button id="stop-btn" disabled
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-stop mr-2"></i>Parar
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Progresso
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span id="progress-text">Pronto para iniciar</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div id="progress-bar" 
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 h-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="current-search" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            Aguardando in√≠cio...
                        </div>
                        <div id="status-messages" class="text-xs text-gray-500 mt-2 space-y-1 max-h-20 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Empresas</p>
                        <p id="stat-companies" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-building text-4xl text-purple-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Buscas</p>
                        <p id="stat-searches" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-search text-4xl text-blue-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">M√©dia/Busca</p>
                        <p id="stat-average" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-chart-pie text-4xl text-green-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm">Taxa Sucesso</p>
                        <p id="stat-success-rate" class="text-3xl font-bold">0%</p>
                    </div>
                    <i class="fas fa-brain text-4xl text-orange-200"></i>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">
                <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                Analytics Avan√ßado
            </h2>

            <!-- Performance Metrics -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">Tempo M√©dio Busca</h3>
                    <p id="avg-search-time" class="text-2xl font-bold text-blue-600">--</p>
                    <p class="text-sm text-blue-600">segundos por busca</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">An√°lises IA</h3>
                    <p id="ai-analyses-count" class="text-2xl font-bold text-green-600">--</p>
                    <p class="text-sm text-green-600">an√°lises realizadas</p>
                </div>
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4">
                    <h3 class="font-semibold text-orange-800 mb-2">Cache Hit Rate</h3>
                    <p id="cache-hit-rate" class="text-2xl font-bold text-orange-600">--%</p>
                    <p class="text-sm text-orange-600">efici√™ncia do cache</p>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">Tempo M√©dio Busca</h3>
                    <p id="avg-search-time" class="text-2xl font-bold text-blue-600">--</p>
                    <p class="text-sm text-blue-600">segundos por busca</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">An√°lises IA</h3>
                    <p id="ai-analyses-count" class="text-2xl font-bold text-green-600">--</p>
                    <p class="text-sm text-green-600">an√°lises realizadas</p>
                </div>
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4">
                    <h3 class="font-semibold text-orange-800 mb-2">Cache Hit Rate</h3>
                    <p id="cache-hit-rate" class="text-2xl font-bold text-orange-600">--%</p>
                    <p class="text-sm text-orange-600">efici√™ncia do cache</p>
                </div>
            </div>

            <!-- Learning Stats -->
            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4">
                    <h3 class="font-semibold text-indigo-800 mb-2">Buscas Aprendidas</h3>
                    <p id="learning-searches" class="text-2xl font-bold text-indigo-600">0</p>
                    <p class="text-sm text-indigo-600">Total de buscas no hist√≥rico</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">Sucessos</h3>
                    <p id="learning-successes" class="text-2xl font-bold text-green-600">0</p>
                    <p class="text-sm text-green-600">Buscas que encontraram empresas</p>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4">
                    <h3 class="font-semibold text-red-800 mb-2">Falhas</h3>
                    <p id="learning-failures" class="text-2xl font-bold text-red-600">0</p>
                    <p class="text-sm text-red-600">Buscas sem resultados</p>
                </div>
            </div>

            <!-- Top Neighborhoods with Heat Map -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-gray-800 mb-3">Top Bairros (Mapa de Calor)</h3>
                <div id="neighborhood-heatmap" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                    <div class="text-center text-gray-500">Carregando mapa de calor...</div>
                </div>
            </div>
        </div>

        <!-- Previous Searches -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-history text-blue-600 mr-2"></i>
                    Buscas Anteriores
                </h2>
                <button id="toggle-searches-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                    <i class="fas fa-eye mr-1"></i>Mostrar/Ocultar
                </button>
            </div>
            <div id="searches-container" class="space-y-2 max-h-64 overflow-y-auto hidden">
                <p class="text-gray-500 text-center py-4">Carregando buscas anteriores...</p>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-list text-green-600 mr-2"></i>
                    Empresas Encontradas
                    <span id="data-status" class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full hidden">
                        <i class="fas fa-sync-alt fa-spin mr-1"></i>Sincronizando...
                    </span>
                </h2>
                <div class="flex gap-2">
                    <button id="filter-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-colors">
                        <i class="fas fa-filter mr-1"></i>Filtros
                    </button>
                    <button id="sync-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600 transition-colors">
                        <i class="fas fa-cloud mr-1"></i>Sincronizar
                    </button>
                    <button id="load-more-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-1"></i>Carregar Mais
                    </button>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div id="filters-container" class="mb-4 p-4 bg-gray-50 rounded-lg hidden">
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                        <select id="filter-neighborhood" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="Aldeota">Aldeota</option>
                            <option value="Meireles">Meireles</option>
                            <option value="Mucuripe">Mucuripe</option>
                            <option value="Varjota">Varjota</option>
                            <option value="Papicu">Papicu</option>
                            <option value="Centro">Centro</option>
                            <option value="Benfica">Benfica</option>
                            <option value="Messejana">Messejana</option>
                            <option value="Parangaba">Parangaba</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Neg√≥cio</label>
                        <select id="filter-business" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todos</option>
                            <option value="restaurante">Restaurante</option>
                            <option value="advogado">Advogado</option>
                            <option value="dentista">Dentista</option>
                            <option value="sal√£o beleza">Sal√£o de Beleza</option>
                            <option value="academia">Academia</option>
                            <option value="pet shop">Pet Shop</option>
                            <option value="mec√¢nica">Mec√¢nica</option>
                            <option value="loja roupas">Loja de Roupas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <select id="filter-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todas</option>
                            <option value="today">Hoje</option>
                            <option value="week">√öltima semana</option>
                            <option value="month">√öltimo m√™s</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
                        <select id="sort-by" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="date">Data (mais recente)</option>
                            <option value="name">Nome (A-Z)</option>
                            <option value="neighborhood">Bairro</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="apply-filters" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors">
                        <i class="fas fa-check mr-1"></i>Aplicar
                    </button>
                    <button id="clear-filters" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors">
                        <i class="fas fa-times mr-1"></i>Limpar
                    </button>
                </div>
            </div>

            <div id="results-container" class="space-y-3 max-h-96 overflow-y-auto">
                <div id="loading-indicator" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="text-gray-500 mt-2">Carregando empresas encontradas...</p>
                </div>
                <p id="no-results-message" class="text-gray-500 text-center py-8 hidden">Nenhuma empresa encontrada ainda</p>
            </div>
            <div id="results-info" class="mt-4 text-sm text-gray-600 text-center">
                Mostrando <span id="results-shown">0</span> de <span id="results-total">0</span> empresas encontradas
            </div>
        </div>

        <!-- Analytics Footer -->
        <div class="mt-6 text-center text-xs text-gray-500">
            <p>üí° Sistema de Prospec√ß√£o Inteligente com IA | Cache ativo | Analytics em tempo real</p>
        </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let currentSearchIndex = 0;
        let maxSearches = 10;
        let searchInterval = null;
        let currentOffset = 0;
        const resultsPerPage = 20;

        // Filter state
        let currentFilters = {
            neighborhood: '',
            businessType: '',
            dateRange: '',
            sortBy: 'date'
        };

        // Offline support
        let isOnline = navigator.onLine;
        let offlineData = null;

        const elements = {
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            statusBadge: document.getElementById('status-badge'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            currentSearch: document.getElementById('current-search'),
            resultsContainer: document.getElementById('results-container'),
            maxSearchesInput: document.getElementById('max-searches'),
            statusMessages: document.getElementById('status-messages'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            resultsShown: document.getElementById('results-shown'),
            resultsTotal: document.getElementById('results-total'),
            statSuccessRate: document.getElementById('stat-success-rate'),
            learningSearches: document.getElementById('learning-searches'),
            learningSuccesses: document.getElementById('learning-successes'),
            learningFailures: document.getElementById('learning-failures'),
            topLearningNeighborhoods: document.getElementById('top-learning-neighborhoods'),
            toggleSearchesBtn: document.getElementById('toggle-searches-btn'),
            searchesContainer: document.getElementById('searches-container'),
            filterBtn: document.getElementById('filter-btn'),
            filtersContainer: document.getElementById('filters-container'),
            filterNeighborhood: document.getElementById('filter-neighborhood'),
            filterBusiness: document.getElementById('filter-business'),
            filterDate: document.getElementById('filter-date'),
            sortBy: document.getElementById('sort-by'),
            applyFilters: document.getElementById('apply-filters'),
            clearFilters: document.getElementById('clear-filters'),
            dataStatus: document.getElementById('data-status'),
            syncBtn: document.getElementById('sync-btn'),
            refreshBtn: document.getElementById('refresh-btn')
        };

        // Load saved filters and settings
        loadSavedSettings();

        // Start prospecting
        elements.startBtn.addEventListener('click', startProspecting);
        elements.stopBtn.addEventListener('click', stopProspecting);
        elements.loadMoreBtn.addEventListener('click', loadMoreResults);
        elements.toggleSearchesBtn.addEventListener('click', toggleSearches);
        elements.filterBtn.addEventListener('click', toggleFilters);
        elements.applyFilters.addEventListener('click', applyFilters);
        elements.clearFilters.addEventListener('click', clearFilters);
        elements.syncBtn.addEventListener('click', showSyncOptions);
        elements.refreshBtn.addEventListener('click', manualRefresh);

        async function startProspecting() {
            if (isRunning) return;

            isRunning = true;
            currentSearchIndex = 0;
            maxSearches = parseInt(elements.maxSearchesInput.value);

            // Save settings when starting
            saveSettings();

            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;
            elements.statusBadge.className = 'px-3 py-1 bg-green-500 text-white rounded-full text-sm animate-pulse';
            elements.statusBadge.innerHTML = '<i class="fas fa-play"></i> Executando';

            performSearch();
        }

        function stopProspecting() {
            isRunning = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.statusBadge.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm';
            elements.statusBadge.innerHTML = '<i class="fas fa-pause"></i> Parado';
            addStatusMessage('Prospec√ß√£o parada pelo usu√°rio');
        }

        function addStatusMessage(message) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'text-xs';
            div.innerHTML = `<span class="text-gray-400">${time}:</span> ${message}`;
            elements.statusMessages.appendChild(div);
            elements.statusMessages.scrollTop = elements.statusMessages.scrollHeight;
        }

        async function performSearch() {
            if (!isRunning || currentSearchIndex >= maxSearches) {
                stopProspecting();
                updateProgress(maxSearches, maxSearches);
                loadResults();
                loadStats();
                return;
            }

            try {
                updateProgress(currentSearchIndex, maxSearches);

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        searchIndex: currentSearchIndex,
                        maxSearches: maxSearches
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const statusIcon = data.skipped ? 'üîÑ' : 'üîç';
                    const statusText = data.skipped ? 'Busca pulada (j√° realizada)' : data.searchTerm;

                    elements.currentSearch.innerHTML = `
                        <strong>${statusIcon} ${statusText}</strong><br>
                        <small class="text-gray-500">
                            ${data.neighborhood} ‚Ä¢ ${data.businessType} ‚Ä¢ ${data.resultsFound} resultados
                        </small>
                    `;

                    if (data.skipped) {
                        addStatusMessage(`Busca pulada: "${data.searchTerm}" j√° foi realizada anteriormente`);
                    } else {
                        addStatusMessage(`Encontrados ${data.resultsFound} resultados para "${data.searchTerm}"`);
                    }

                    if (data.resultsFound > 0) {
                        // Filter only AI-approved results for display
                        const approvedResults = data.results.filter(result =>
                            result.aiValidation && result.aiValidation.isValid === true
                        );

                        if (approvedResults.length > 0) {
                            addResults(approvedResults);
                            addStatusMessage(`${approvedResults.length} empresas aprovadas adicionadas √† lista`);
                        } else {
                            addStatusMessage(`${data.resultsFound} resultados encontrados, mas nenhum aprovado pela IA`);
                        }

                        // Update local cache after successful search (with all results)
                        updateLocalCache();
                    }

                    currentSearchIndex++;

                    if (isRunning && currentSearchIndex < maxSearches) {
                        addStatusMessage(`Aguardando 5 segundos para pr√≥xima busca...`);
                        setTimeout(performSearch, 5000); // 5s entre buscas
                    } else {
                        addStatusMessage('Prospec√ß√£o conclu√≠da!');
                        stopProspecting();
                        // Only update stats after completion, results are already updated
                        loadStats();
                    }
                } else {
                    console.error('Erro:', data.error);
                    addStatusMessage(`Erro na busca: ${data.error}`);
                    currentSearchIndex++;
                    if (isRunning) {
                        addStatusMessage('Tentando pr√≥xima busca em 5 segundos...');
                        setTimeout(performSearch, 5000);
                    }
                }

            } catch (error) {
                console.error('Erro na busca:', error);
                currentSearchIndex++;
                if (isRunning) setTimeout(performSearch, 5000);
            }
        }

        function updateProgress(current, total) {
            const percent = total > 0 ? (current / total) * 100 : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${Math.round(percent)}%`;
            elements.progressText.textContent = `${current}/${total} buscas`;
        }

        function addResults(results, append = false) {
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            const noResultsMessage = document.getElementById('no-results-message');

            if (!append) {
                if (elements.resultsContainer) {
                    elements.resultsContainer.innerHTML = '';
                }
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }

            if (results.length === 0 && !append) {
                if (noResultsMessage) {
                    noResultsMessage.classList.remove('hidden');
                }
                return;
            }

            if (noResultsMessage) {
                noResultsMessage.classList.add('hidden');
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition-colors border-l-4 border-green-500';
                const foundDate = result.foundAt ? new Date(result.foundAt).toLocaleDateString('pt-BR') : 'N/A';
                const searchTerm = result.searchTerm || 'N/A';
                const neighborhood = result.neighborhood || 'N/A';
                const businessType = result.businessType || 'N/A';
                const googlePage = result.googlePage ? ` (P√°gina ${result.googlePage})` : '';

                div.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-gray-800 flex-1">${result.title}</h3>
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">${foundDate}${googlePage}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-2">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${neighborhood}</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded mr-1">${businessType}</span>
                        <span class="text-gray-500">‚Ä¢ ${searchTerm}</span>
                    </div>
                    <a href="${result.url}" target="_blank" class="text-blue-600 text-sm hover:underline block mb-2">
                        ${result.url.length > 60 ? result.url.substring(0, 60) + '...' : result.url}
                    </a>
                    <p class="text-gray-600 text-sm">${result.description ? result.description.substring(0, 150) + '...' : 'Sem descri√ß√£o'}</p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="analyzeCompany('${result.url.replace(/'/g, '\\\'')}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 transition-colors">
                            <i class="fas fa-brain mr-1"></i>Analisar IA
                        </button>
                        <button onclick="openCompany('${result.url}')" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600 transition-colors">
                            <i class="fas fa-external-link-alt mr-1"></i>Visitar
                        </button>
                    </div>
                `;
                if (elements.resultsContainer) {
                    elements.resultsContainer.appendChild(div);
                }
            });
        }

        function loadMoreResults() {
            currentOffset += resultsPerPage;
            loadResults(true);
        }

        function openCompany(url) {
            window.open(url, '_blank');
        }

        async function analyzeCompany(url) {
            if (confirm('Deseja analisar esta empresa com IA? Isso pode levar alguns segundos.')) {
                // Encontrar o ID da empresa baseado na URL
                const companyId = btoa(url).substring(0, 50);
                console.log('Analisando empresa:', companyId, 'URL:', url);

                try {
                    // Show loading state
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Analisando...';
                    button.disabled = true;

                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyze_company_deep',
                            companyId: companyId
                        })
                    });

                    const data = await response.json();
                    console.log('Resposta da an√°lise:', data);

                    if (data.success) {
                        // Show detailed analysis modal
                        showAnalysisModal(data.analysis, url);
                        loadResults(); // Recarregar para mostrar an√°lise
                        loadStats(); // Update analytics
                    } else {
                        console.error('Erro na an√°lise:', data.error);
                        alert('Erro na an√°lise: ' + (data.error || 'Empresa n√£o encontrada'));
                    }
                } catch (error) {
                    console.error('Erro ao analisar empresa:', error);
                    alert('Erro ao analisar empresa: ' + error.message);
                } finally {
                    // Restore button state
                    const currentButton = event.target.closest('button');
                    if (currentButton) {
                        currentButton.innerHTML = originalText;
                        currentButton.disabled = false;
                    }
                }
            }
        }

        function showAnalysisModal(analysis, companyUrl) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-brain text-purple-600 mr-2"></i>
                                An√°lise IA Completa
                            </h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Basic Analysis -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-blue-800 mb-2">Perfil da Empresa</h3>
                                    <p class="text-blue-700">${analysis.analysis || 'An√°lise n√£o dispon√≠vel'}</p>
                                </div>

                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-green-800 mb-2">Predi√ß√£o de Convers√£o</h3>
                                    <div class="flex items-center mb-2">
                                        <div class="flex-1 bg-gray-200 rounded-full h-3">
                                            <div class="bg-green-500 h-3 rounded-full" style="width: ${analysis.prediction?.score || 0}%"></div>
                                        </div>
                                        <span class="ml-2 font-bold text-green-700">${analysis.prediction?.score || 0}%</span>
                                    </div>
                                    <p class="text-sm text-green-700">${analysis.prediction?.recommendation || 'Sem recomenda√ß√£o'}</p>
                                    <p class="text-xs text-green-600 mt-1">Categoria: ${analysis.prediction?.category || 'N/A'}</p>
                                </div>

                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-yellow-800 mb-2">An√°lise de Sentimento</h3>
                                    <p class="text-yellow-700">${analysis.sentiment?.sentiment || 'N/A'} - ${analysis.sentiment?.reason || ''}</p>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-purple-800 mb-2">Recomenda√ß√µes de Abordagem</h3>
                                    ${analysis.approachRecommendations?.recommendations ?
                                        analysis.approachRecommendations.recommendations.map(rec => `
                                            <div class="mb-2 p-2 bg-white rounded border-l-4 border-purple-300">
                                                <p class="text-sm text-purple-700">${rec}</p>
                                            </div>
                                        `).join('') :
                                        '<p class="text-purple-700">Nenhuma recomenda√ß√£o espec√≠fica</p>'
                                    }
                                </div>

                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-indigo-800 mb-2">Fatores Positivos</h3>
                                    <div class="flex flex-wrap gap-1">
                                        ${analysis.prediction?.factors ?
                                            analysis.prediction.factors.map(factor => `
                                                <span class="bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full text-xs">${factor.replace(/_/g, ' ')}</span>
                                            `).join('') :
                                            '<span class="text-indigo-600">Nenhum fator identificado</span>'
                                        }
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="window.open('${companyUrl}', '_blank')"
                                            class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                        <i class="fas fa-external-link-alt mr-1"></i>Visitar Site
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()"
                                            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-times mr-1"></i>Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function loadResults(append = false, applyCurrentFilters = false) {
            try {
                const limit = append ? resultsPerPage : 50;
                const offset = append ? currentOffset : 0;

                // Build query parameters
                let queryParams = `limit=${limit}&offset=${offset}&includeSearches=true`;

                if (applyCurrentFilters) {
                    if (currentFilters.neighborhood) queryParams += `&neighborhood=${encodeURIComponent(currentFilters.neighborhood)}`;
                    if (currentFilters.businessType) queryParams += `&businessType=${encodeURIComponent(currentFilters.businessType)}`;
                    if (currentFilters.dateRange) queryParams += `&dateRange=${encodeURIComponent(currentFilters.dateRange)}`;
                    if (currentFilters.sortBy) queryParams += `&sortBy=${encodeURIComponent(currentFilters.sortBy)}`;
                }

                const response = await fetch(`/api/results?${queryParams}`);
                const data = await response.json();

                if (data.success) {
                    if (!append) {
                        elements.resultsContainer.innerHTML = '';
                    }

                    if (data.results.length > 0) {
                        addResults(data.results, append);
                    } else if (!append) {
                        elements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum resultado encontrado com os filtros aplicados</p>';
                    }

                    elements.resultsTotal.textContent = data.total;
                    elements.resultsShown.textContent = append ?
                        Math.min(currentOffset + data.results.length, data.total) :
                        Math.min(data.results.length, data.total);

                    elements.loadMoreBtn.style.display = data.pagination.hasMore ? 'block' : 'none';

                    // Carregar buscas anteriores
                    if (data.previousSearches) {
                        loadPreviousSearches(data.previousSearches);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar resultados:', error);
            }
        }

        function toggleSearches() {
            const isHidden = elements.searchesContainer.classList.contains('hidden');
            if (isHidden) {
                elements.searchesContainer.classList.remove('hidden');
                elements.toggleSearchesBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Ocultar';
            } else {
                elements.searchesContainer.classList.add('hidden');
                elements.toggleSearchesBtn.innerHTML = '<i class="fas fa-eye mr-1"></i>Mostrar';
            }
        }

        function loadPreviousSearches(searches) {
            if (searches.length === 0) {
                elements.searchesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma busca anterior encontrada</p>';
                return;
            }

            elements.searchesContainer.innerHTML = '';

            searches.forEach(search => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg border-l-4 border-blue-500';
                const completedDate = search.completedAt ? new Date(search.completedAt).toLocaleDateString('pt-BR') : 'N/A';

                div.innerHTML = `
                    <div class="flex items-start justify-between mb-1">
                        <h4 class="font-semibold text-gray-800 text-sm">${search.searchTerm}</h4>
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">${completedDate}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${search.neighborhood}</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded mr-1">${search.businessType}</span>
                        <span class="text-gray-500">‚Ä¢ ${search.resultsCount} resultados</span>
                    </div>
                `;

                elements.searchesContainer.appendChild(div);
            });
        }

        function toggleFilters() {
            const isHidden = elements.filtersContainer.classList.contains('hidden');
            if (isHidden) {
                elements.filtersContainer.classList.remove('hidden');
                elements.filterBtn.innerHTML = '<i class="fas fa-times mr-1"></i>Ocultar Filtros';
            } else {
                elements.filtersContainer.classList.add('hidden');
                elements.filterBtn.innerHTML = '<i class="fas fa-filter mr-1"></i>Filtros';
            }
        }

        function applyFilters() {
            currentFilters.neighborhood = elements.filterNeighborhood.value;
            currentFilters.businessType = elements.filterBusiness.value;
            currentFilters.dateRange = elements.filterDate.value;
            currentFilters.sortBy = elements.sortBy.value;

            saveSettings(); // Save filters

            currentOffset = 0; // Reset pagination
            loadResults(false, true); // Reload with filters
            toggleFilters(); // Hide filters
        }

        function clearFilters() {
            elements.filterNeighborhood.value = '';
            elements.filterBusiness.value = '';
            elements.filterDate.value = '';
            elements.sortBy.value = 'date';

            currentFilters = {
                neighborhood: '',
                businessType: '',
                dateRange: '',
                sortBy: 'date'
            };

            currentOffset = 0;
            loadResults(false, true);
            toggleFilters();
        }

        function handleOnline() {
            isOnline = true;
            console.log('Conex√£o restaurada');
            addStatusMessage('Conex√£o com internet restaurada - sincronizando dados...');
            showDataStatus('Conex√£o restaurada - sincronizando...');

            // Reload and sync data when back online
            loadResults();
            loadStats();
            syncDataWithServer();
        }

        function handleOffline() {
            isOnline = false;
            console.log('Sem conex√£o com internet');
            addStatusMessage('Modo offline ativado - algumas funcionalidades podem n√£o funcionar');

            // Load cached data
            loadOfflineData();
        }

        async function loadOfflineData() {
            try {
                const cachedData = localStorage.getItem('prospectOfflineData');
                if (cachedData) {
                    offlineData = JSON.parse(cachedData);
                    console.log('Dados offline carregados');

                    // Show offline indicator
                    if (!isOnline) {
                        showOfflineMode();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados offline:', error);
            }
        }

        function showOfflineMode() {
            // Add offline indicator to header
            const header = document.querySelector('nav');
            if (header && !header.querySelector('.offline-indicator')) {
                const offlineDiv = document.createElement('div');
                offlineDiv.className = 'offline-indicator px-3 py-1 bg-orange-500 text-white rounded-full text-sm';
                offlineDiv.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i>Offline';
                header.querySelector('.flex.items-center.justify-between').appendChild(offlineDiv);
            }

            // Disable online-only features
            elements.startBtn.disabled = true;
            elements.startBtn.title = 'Indispon√≠vel no modo offline';
        }

        function hideOfflineMode() {
            // Remove offline indicator
            const indicator = document.querySelector('.offline-indicator');
            if (indicator) {
                indicator.remove();
            }

            // Re-enable features
            elements.startBtn.disabled = false;
            elements.startBtn.title = '';
        }

        // Enhanced loadResults with offline support and AI filtering
        const originalLoadResults = loadResults;
        loadResults = async function(append = false, applyCurrentFilters = false) {
            if (!isOnline && offlineData) {
                // Use offline data - filter only AI-approved companies
                console.log('Usando dados offline');

                let allResults = offlineData.results || [];
                let filteredResults = allResults.filter(company =>
                    company.aiValidation && company.aiValidation.isValid === true
                );

                // Apply current filters to offline data
                if (applyCurrentFilters) {
                    if (currentFilters.neighborhood) {
                        filteredResults = filteredResults.filter(r => r.neighborhood === currentFilters.neighborhood);
                    }
                    if (currentFilters.businessType) {
                        filteredResults = filteredResults.filter(r => r.businessType === currentFilters.businessType);
                    }
                }

                // Apply sorting
                switch (currentFilters.sortBy) {
                    case 'name':
                        filteredResults.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                        break;
                    case 'neighborhood':
                        filteredResults.sort((a, b) => (a.neighborhood || '').localeCompare(b.neighborhood || ''));
                        break;
                    case 'date':
                    default:
                        filteredResults.sort((a, b) => (b.foundAt || 0) - (a.foundAt || 0));
                        break;
                }

                // Paginate
                const limit = append ? resultsPerPage : 50;
                const offset = append ? currentOffset : 0;
                const paginatedResults = filteredResults.slice(offset, offset + limit);

                if (paginatedResults.length > 0) {
                    addResults(paginatedResults, append);
                } else if (!append) {
                    elements.resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum resultado aprovado encontrado (modo offline)</p>';
                }

                elements.resultsTotal.textContent = filteredResults.length;
                elements.resultsShown.textContent = append ?
                    Math.min(currentOffset + paginatedResults.length, filteredResults.length) :
                    Math.min(paginatedResults.length, filteredResults.length);

                return;
            }

            // Online mode - call original function and cache results
            try {
                await originalLoadResults.call(this, append, applyCurrentFilters);

                // Cache successful responses for offline use
                if (isOnline && !append) {
                    const response = await fetch(`/api/results?limit=100&offset=0&includeSearches=true`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            localStorage.setItem('prospectOfflineData', JSON.stringify(data));
                        }
                    }
                }
            } catch (error) {
                console.error('Erro no modo online, tentando offline:', error);
                if (offlineData) {
                    return loadResults.call(this, append, applyCurrentFilters);
                }
            }
        };

        // Auto-sync local data to cloud if needed
        async function autoSyncLocalToCloud() {
            try {
                // Check if we have local data that needs to be synced
                const cachedData = localStorage.getItem('prospectDashboardData');
                if (!cachedData) return false;

                const localData = JSON.parse(cachedData);
                if (!localData.results || localData.results.length === 0) return false;

                // Check server data
                const serverResponse = await fetch('/api/results?limit=1&offset=0');
                if (!serverResponse.ok) return false;

                const serverData = await serverResponse.json();
                if (!serverData.success) return false;

                // If server has much less data than local, sync local to cloud
                const serverCount = serverData.total || 0;
                const localCount = localData.results.length;

                if (localCount > serverCount * 2) { // Local has at least 2x more data
                    console.log(`üîÑ Detectado desync: Local=${localCount}, Nuvem=${serverCount}. Sincronizando...`);

                    showDataStatus('Sincronizando dados locais para nuvem...', 'info');

                    const syncResponse = await fetch('/api/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'merge_data',
                            data: {
                                companies: localData.results,
                                stats: localData.stats || {},
                                learning: localData.learning || {}
                            }
                        })
                    });

                    const syncResult = await syncResponse.json();
                    if (syncResult.success) {
                        console.log(`‚úÖ Auto-sincroniza√ß√£o conclu√≠da: ${syncResult.mergedCount} novos, ${syncResult.updatedCount} atualizados`);
                        showDataStatus(`Sincroniza√ß√£o autom√°tica conclu√≠da`, 'success');
                        return true;
                    }
                }

                return false;
            } catch (error) {
                console.error('Erro na auto-sincroniza√ß√£o:', error);
                return false;
            }
        }

        // Load initial data with persistence
        async function loadInitialData() {
            try {
                showDataStatus('Carregando dados...');

                // First try to load from localStorage
                const cachedData = localStorage.getItem('prospectDashboardData');
                if (cachedData) {
                    const localData = JSON.parse(cachedData);
                    if (localData.results && localData.results.length > 0) {
                        // Filter only AI-approved companies
                        const approvedCompanies = localData.results.filter(company =>
                            company.aiValidation && company.aiValidation.isValid === true
                        );

                        if (approvedCompanies.length > 0) {
                            console.log(`Carregando ${approvedCompanies.length} empresas aprovadas do cache local...`);
                            addResults(approvedCompanies, false);
                            elements.resultsTotal.textContent = approvedCompanies.length;
                            elements.resultsShown.textContent = approvedCompanies.length;

                            // Load searches if available
                            if (localData.previousSearches) {
                                loadPreviousSearches(localData.previousSearches);
                            }

                            showDataStatus(`${approvedCompanies.length} empresas aprovadas carregadas`, 'success');
                        } else {
                            console.log('Nenhuma empresa aprovada encontrada no cache local');
                            showDataStatus('Nenhuma empresa aprovada no cache', 'warning');
                        }
                    }
                }

                // Then try to load from server (will override local if newer)
                if (isOnline) {
                    showDataStatus('Sincronizando com servidor...');

                    // Try auto-sync first
                    const wasAutoSynced = await autoSyncLocalToCloud();

                    // Load ALL results from server (not just first page)
                    const response = await fetch('/api/results?limit=1000&offset=0&includeSearches=true');
                    if (response.ok) {
                        const serverData = await response.json();
                        if (serverData.success && serverData.results.length > 0) {
                            // Show ALL companies for now (we can filter later if needed)
                            // TODO: Add toggle for showing only AI-approved companies
                            const allCompanies = serverData.results;

                            if (allCompanies.length > 0) {
                                // Show all results
                                addResults(allCompanies, false);
                                elements.resultsTotal.textContent = allCompanies.length;
                                elements.resultsShown.textContent = allCompanies.length;

                                // Load searches
                                if (serverData.previousSearches) {
                                    loadPreviousSearches(serverData.previousSearches);
                                }

                                // Update local cache with ALL server data
                                localStorage.setItem('prospectDashboardData', JSON.stringify({
                                    results: serverData.results,
                                    total: serverData.total,
                                    previousSearches: serverData.previousSearches,
                                    lastSync: Date.now()
                                }));

                                const syncMessage = wasAutoSynced ?
                                    `${allCompanies.length} empresas sincronizadas (auto-sync executado)` :
                                    `${allCompanies.length} empresas sincronizadas`;

                                console.log(`Carregadas ${allCompanies.length} empresas do servidor`);
                                showDataStatus(syncMessage, 'success');
                            } else {
                                console.log('Nenhuma empresa encontrada no servidor');
                                showDataStatus('Nenhuma empresa no servidor', 'warning');
                            }
                        } else {
                            // If no server data, try local cache
                            console.log('Nenhum dado no servidor, tentando cache local...');
                            showDataStatus('Usando dados locais', 'warning');
                        }
                    } else {
                        showDataStatus('Erro na sincroniza√ß√£o', 'error');
                    }
                } else {
                    console.log('Modo offline - usando dados em cache');
                    showDataStatus('Modo offline', 'warning');
                }
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                showDataStatus('Erro ao carregar dados', 'error');
                // Fallback to basic load
                loadResults();
            }
        }

        // Show data status indicator
        function showDataStatus(message, type = 'info') {
            const statusEl = elements.dataStatus;
            statusEl.textContent = message;
            statusEl.className = 'ml-2 text-xs px-2 py-1 rounded-full';

            // Remove existing type classes
            statusEl.classList.remove('bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');

            switch (type) {
                case 'success':
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                    statusEl.innerHTML = '<i class="fas fa-check mr-1"></i>' + message;
                    break;
                case 'warning':
                    statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>' + message;
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                    statusEl.innerHTML = '<i class="fas fa-times mr-1"></i>' + message;
                    break;
                default:
                    statusEl.classList.add('bg-blue-100', 'text-blue-800');
                    statusEl.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-1"></i>' + message;
            }

            statusEl.classList.remove('hidden');

            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        async function loadStats() {
            try {
                // Use API results with minimal data to get stats
                const response = await fetch('/api/results?limit=1&offset=0');
                const data = await response.json();

                if (data.success && data.stats) {
                    // Basic stats - verificar se elementos existem antes de usar
                    const statCompaniesEl = document.getElementById('stat-companies');
                    const statSearchesEl = document.getElementById('stat-searches');
                    const statAverageEl = document.getElementById('stat-average');
                    const statSuccessRateEl = document.getElementById('stat-success-rate');

                    if (statCompaniesEl) statCompaniesEl.textContent = data.stats.general.uniqueCompanies;
                    if (statSearchesEl) statSearchesEl.textContent = data.stats.general.totalSearches;
                    if (statAverageEl) statAverageEl.textContent = data.stats.general.averagePerSearch;
                    if (statSuccessRateEl) statSuccessRateEl.textContent = data.stats.learning.successRate;

                    // Learning stats
                    const learningSearchesEl = document.getElementById('learning-searches');
                    const learningSuccessesEl = document.getElementById('learning-successes');
                    const learningFailuresEl = document.getElementById('learning-failures');

                    if (learningSearchesEl) learningSearchesEl.textContent = data.stats.learning.totalLearningSearches;
                    if (learningSuccessesEl) learningSuccessesEl.textContent = data.stats.learning.successfulSearches;
                    if (learningFailuresEl) learningFailuresEl.textContent = data.stats.learning.failedSearches;

                    // Analytics data
                    if (data.stats.analytics) {
                        updateAnalyticsDashboard(data.stats.analytics);
                    }

                    // Top bairros do aprendizado
                    if (data.stats.learning.topNeighborhoods && elements.topLearningNeighborhoods) {
                        const neighborhoodsHtml = data.stats.learning.topNeighborhoods.map(n =>
                            `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">${n.name} (${n.score})</span>`
                        ).join(' ');
                        elements.topLearningNeighborhoods.innerHTML = neighborhoodsHtml || '<span class="text-gray-500 text-xs">Nenhum dado ainda</span>';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        function updateAnalyticsDashboard(analytics) {
            // Performance metrics
            const searchTimeEl = document.getElementById('avg-search-time');
            const aiAnalysesEl = document.getElementById('ai-analyses-count');
            const cacheHitEl = document.getElementById('cache-hit-rate');

            if (analytics.performance) {
                if (analytics.performance.search_duration) {
                    searchTimeEl.textContent = (analytics.performance.search_duration.avg / 1000).toFixed(1);
                }
                if (analytics.performance.ai_analysis_duration) {
                    aiAnalysesEl.textContent = analytics.performance.ai_analysis_duration.count || 0;
                }
            }

            // User activity
            if (analytics.userActivity) {
                // Calculate cache hit rate from user actions
                const cacheHits = analytics.userActivity.topActions?.ai_analysis_cache_hit || 0;
                const totalAnalyses = (analytics.userActivity.topActions?.ai_analysis_requested || 0) +
                                    (analytics.userActivity.topActions?.deep_analysis_requested || 0);
                const hitRate = totalAnalyses > 0 ? ((cacheHits / totalAnalyses) * 100).toFixed(0) : 0;
                cacheHitEl.textContent = hitRate + '%';
            }

            // Update heatmap
            updateNeighborhoodHeatmap(analytics);
        }


        function updateNeighborhoodHeatmap(analytics) {
            const container = document.getElementById('neighborhood-heatmap');
            if (!container) return;

            // Get companies by neighborhood from the current data (no separate API call needed)
            // This function is called from updateAnalyticsDashboard with analytics data
            // For now, we'll get the data from a lightweight API call to results
            fetch('/api/results?limit=1&offset=0')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.stats) {
                        // Get companies by neighborhood (where companies were actually found)
                        const neighborhoodStats = data.stats.general.companiesByNeighborhood || {};

                        // Convert to array and sort by hits (descending)
                        const neighborhoods = Object.entries(neighborhoodStats)
                            .map(([name, hits]) => ({ name, score: hits }))
                            .sort((a, b) => b.score - a.score);

                        if (neighborhoods.length > 0) {
                            // Calculate intensity based on score
                            const maxScore = Math.max(...neighborhoods.map(n => n.score));

                            container.innerHTML = neighborhoods.map(neighborhood => {
                                const intensity = Math.round((neighborhood.score / maxScore) * 100);

                                // Color based on intensity
                                let bgColor, textColor;
                                if (intensity >= 80) {
                                    bgColor = 'bg-red-500';
                                    textColor = 'text-white';
                                } else if (intensity >= 60) {
                                    bgColor = 'bg-orange-500';
                                    textColor = 'text-white';
                                } else if (intensity >= 40) {
                                    bgColor = 'bg-yellow-500';
                                    textColor = 'text-black';
                                } else {
                                    bgColor = 'bg-green-500';
                                    textColor = 'text-white';
                                }

                                return `
                                    <div class="${bgColor} ${textColor} rounded-lg p-3 text-center">
                                        <div class="font-semibold text-sm">${neighborhood.name}</div>
                                        <div class="text-xs opacity-90">${neighborhood.score} empresas</div>
                                        <div class="text-xs opacity-75">${intensity}%</div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            container.innerHTML = `
                                <div class="col-span-full text-center text-gray-500 py-4">
                                    <i class="fas fa-map-marked-alt text-2xl mb-2"></i>
                                    <p>Nenhum bairro pesquisado ainda</p>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro carregando mapa de calor:', error);
                    container.innerHTML = `
                        <div class="col-span-full text-center text-gray-500 py-4">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Erro ao carregar mapa de calor</p>
                        </div>
                    `;
                });
        }

        // Load initial data
        loadInitialData();
        loadStats();

        // Start smart auto-refresh system
        startSmartAutoRefresh();

        // Smart auto-refresh system
        let lastDataHash = null;
        let autoRefreshInterval = null;

        // Calculate simple hash of data for change detection
        function calculateDataHash(data) {
            if (!data) return null;
            const str = JSON.stringify({
                total: data.total,
                companiesCount: data.results?.length || 0,
                lastUpdate: data.results?.[0]?.foundAt
            });
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }

        // Check for data changes
        async function checkForDataChanges() {
            if (!isOnline) return;

            try {
                const response = await fetch('/api/results?limit=1&offset=0');
                if (!response.ok) return;

                const data = await response.json();
                if (!data.success) return;

                const currentHash = calculateDataHash(data);

                if (lastDataHash && lastDataHash !== currentHash) {
                    console.log('Data changes detected, updating dashboard...');
                    showDataStatus('Novos dados dispon√≠veis - atualizando...', 'info');

                    // Update all data from single API call
                    await loadStats();
                    await loadResults();

                    showDataStatus('Dashboard atualizado automaticamente', 'success');
                }

                lastDataHash = currentHash;
            } catch (error) {
                console.error('Error checking for data changes:', error);
            }
        }

        // Start smart auto-refresh (check every 3 minutes)
        function startSmartAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);

            autoRefreshInterval = setInterval(checkForDataChanges, 180000); // 3 minutes
            console.log('Smart auto-refresh started (checks every 3 minutes)');
        }

        // Manual refresh function
        async function manualRefresh() {
            if (!isOnline) {
                showDataStatus('Sem conex√£o com internet', 'warning');
                return;
            }

            const btn = elements.refreshBtn;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                console.log('Manual refresh: updating data...');
                showDataStatus('Atualizando dados...', 'info');

                // Update both stats and results
                await loadStats();
                await loadResults();

                // Reset hash after manual refresh
                const response = await fetch('/api/results?limit=1&offset=0');
                if (response.ok) {
                    const data = await response.json();
                    lastDataHash = calculateDataHash(data);
                }

                showDataStatus('Dados atualizados com sucesso', 'success');
            } catch (error) {
                console.error('Erro no refresh manual:', error);
                showDataStatus('Erro ao atualizar dados', 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Auto-refresh is now optimized to run every 5 minutes instead of 30 seconds

        // Offline support
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        // Load offline data if exists
        loadOfflineData();

        // Load and save settings functions
        function loadSavedSettings() {
            try {
                const savedSettings = localStorage.getItem('prospectSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    currentFilters = settings.filters || currentFilters;

                    // Apply saved filter values to UI
                    elements.filterNeighborhood.value = currentFilters.neighborhood || '';
                    elements.filterBusiness.value = currentFilters.businessType || '';
                    elements.filterDate.value = currentFilters.dateRange || '';
                    elements.sortBy.value = currentFilters.sortBy || 'date';
                    elements.maxSearchesInput.value = settings.maxSearches || 10;

                    console.log('Configura√ß√µes salvas carregadas');
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }

        function saveSettings() {
            try {
                const settings = {
                    filters: currentFilters,
                    maxSearches: parseInt(elements.maxSearchesInput.value) || 10,
                    lastSaved: Date.now()
                };
                localStorage.setItem('prospectSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
            }
        }

        // Function to update local cache
        function updateLocalCache() {
            if (isOnline) {
                // Get current data from server and cache locally
                fetch('/api/results?limit=500&offset=0&includeSearches=true')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            localStorage.setItem('prospectDashboardData', JSON.stringify({
                                results: data.results,
                                total: data.total,
                                previousSearches: data.previousSearches,
                                lastSync: Date.now()
                            }));
                            console.log('Cache local atualizado ap√≥s busca');

                            // Update display with only approved companies
                            const approvedCompanies = data.results.filter(company =>
                                company.aiValidation && company.aiValidation.isValid === true
                            );

                            if (approvedCompanies.length > 0) {
                                // Clear current results and show updated approved ones
                                elements.resultsContainer.innerHTML = '';
                                addResults(approvedCompanies, false);
                                elements.resultsTotal.textContent = approvedCompanies.length;
                                elements.resultsShown.textContent = approvedCompanies.length;
                                showDataStatus(`${approvedCompanies.length} empresas aprovadas atualizadas`, 'success');
                            }
                        }
                    })
                    .catch(error => console.error('Erro ao atualizar cache:', error));
            }
        }

        // Sync data with server
        function syncDataWithServer() {
            if (!isOnline) return;

            try {
                // Get latest data from server
                fetch('/api/results?limit=100&offset=0&includeSearches=true')
                    .then(response => response.json())
                    .then(serverData => {
                        if (serverData.success) {
                            // Check if we have newer data locally
                            const localData = localStorage.getItem('prospectDashboardData');
                            let shouldUpdateLocal = true;

                            if (localData) {
                                const parsedLocal = JSON.parse(localData);
                                // If server has more results, update local
                                if (serverData.total > (parsedLocal.total || 0)) {
                                    shouldUpdateLocal = true;
                                }
                            }

                            if (shouldUpdateLocal) {
                                localStorage.setItem('prospectDashboardData', JSON.stringify({
                                    results: serverData.results,
                                    total: serverData.total,
                                    previousSearches: serverData.previousSearches,
                                    lastSync: Date.now()
                                }));
                                console.log('Dados sincronizados com servidor');

                                // Update display with only approved companies
                                const approvedCompanies = serverData.results.filter(company =>
                                    company.aiValidation && company.aiValidation.isValid === true
                                );

                                if (approvedCompanies.length > 0) {
                                    // Clear and reload with approved companies only
                                    elements.resultsContainer.innerHTML = '';
                                    addResults(approvedCompanies, false);
                                    elements.resultsTotal.textContent = approvedCompanies.length;
                                    elements.resultsShown.textContent = approvedCompanies.length;
                                    showDataStatus(`${approvedCompanies.length} empresas aprovadas sincronizadas`, 'success');
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Erro na sincroniza√ß√£o:', error));
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o de dados:', error);
            }
        }

        // Show sync options modal
        function showSyncOptions() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-cloud text-purple-600 mr-2"></i>
                                Sincroniza√ß√£o
                            </h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-3">
                            <button onclick="syncToCloud()" class="w-full bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-upload mr-2"></i>Enviar dados locais para nuvem
                            </button>

                            <button onclick="syncFromCloud()" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-download mr-2"></i>Baixar dados da nuvem
                            </button>

                            <button onclick="mergeData()" class="w-full bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 transition-colors">
                                <i class="fas fa-exchange-alt mr-2"></i>Mesclar dados locais e nuvem
                            </button>
                        </div>

                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>Enviar:</strong> Sincroniza dados locais para a nuvem</p>
                            <p><strong>Baixar:</strong> Substitui dados locais pelos da nuvem</p>
                            <p><strong>Mesclar:</strong> Combina dados locais e da nuvem</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Sync local data to cloud
        async function syncToCloud() {
            try {
                const localData = localStorage.getItem('prospectDashboardData');
                if (!localData) {
                    alert('Nenhum dado local encontrado para sincronizar');
                    return;
                }

                const data = JSON.parse(localData);
                showDataStatus('Enviando dados para nuvem...', 'info');

                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sync_to_cloud',
                        data: data
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showDataStatus(result.message, 'success');
                    // Refresh data after sync
                    loadResults();
                    loadStats();
                } else {
                    showDataStatus('Erro: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                showDataStatus('Erro na sincroniza√ß√£o', 'error');
            }

            // Close modal
            document.querySelector('.fixed')?.remove();
        }

        // Sync data from cloud to local
        async function syncFromCloud() {
            try {
                showDataStatus('Baixando dados da nuvem...', 'info');

                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sync_from_cloud'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Save cloud data to localStorage
                    localStorage.setItem('prospectDashboardData', JSON.stringify(result.data));

                    // Update display with cloud data
                    const approvedCompanies = result.data.companies.filter(company =>
                        company.aiValidation && company.aiValidation.isValid === true
                    );

                    if (approvedCompanies.length > 0) {
                        elements.resultsContainer.innerHTML = '';
                        addResults(approvedCompanies, false);
                        elements.resultsTotal.textContent = approvedCompanies.length;
                        elements.resultsShown.textContent = approvedCompanies.length;
                    }

                    showDataStatus(result.message, 'success');
                    loadStats(); // Update stats
                } else {
                    showDataStatus('Erro: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro ao baixar dados:', error);
                showDataStatus('Erro ao baixar dados', 'error');
            }

            // Close modal
            document.querySelector('.fixed')?.remove();
        }

        // Merge local and cloud data
        async function mergeData() {
            try {
                const localData = localStorage.getItem('prospectDashboardData');
                if (!localData) {
                    alert('Nenhum dado local encontrado para mesclar');
                    return;
                }

                const data = JSON.parse(localData);
                showDataStatus('Mesclando dados...', 'info');

                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'merge_data',
                        data: data
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showDataStatus(result.message, 'success');
                    // Refresh data after merge
                    loadResults();
                    loadStats();
                } else {
                    showDataStatus('Erro: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Erro na mesclagem:', error);
                showDataStatus('Erro na mesclagem', 'error');
            }

            // Close modal
            document.querySelector('.fixed')?.remove();
        }
    </script>
</body>
</html>