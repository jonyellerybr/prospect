<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospec√ß√£o Inteligente - Fortaleza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 min-h-screen">
    <!-- Header -->
    <nav class="bg-white/95 backdrop-blur-sm shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-search-dollar text-purple-600 mr-2"></i>
                    Prospec√ß√£o Fortaleza
                </h1>
                <div class="flex gap-2">
                    <span id="status-badge" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                        <i class="fas fa-pause"></i> Parado
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Controls -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sliders text-purple-600 mr-2"></i>
                        Controles
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                N√∫mero de buscas
                            </label>
                            <input type="number" id="max-searches" value="10" min="1" max="50"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div class="flex gap-3">
                            <button id="start-btn" 
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition-all">
                                <i class="fas fa-play mr-2"></i>Iniciar Prospec√ß√£o
                            </button>
                            <button id="stop-btn" disabled
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-stop mr-2"></i>Parar
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Progresso
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span id="progress-text">Pronto para iniciar</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div id="progress-bar" 
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 h-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="current-search" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            Aguardando in√≠cio...
                        </div>
                        <div id="status-messages" class="text-xs text-gray-500 mt-2 space-y-1 max-h-20 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Empresas</p>
                        <p id="stat-companies" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-building text-4xl text-purple-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Buscas</p>
                        <p id="stat-searches" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-search text-4xl text-blue-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">M√©dia/Busca</p>
                        <p id="stat-average" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-chart-pie text-4xl text-green-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm">Taxa Sucesso</p>
                        <p id="stat-success-rate" class="text-3xl font-bold">0%</p>
                    </div>
                    <i class="fas fa-brain text-4xl text-orange-200"></i>
                </div>
            </div>
        </div>

        <!-- Learning Stats -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">
                <i class="fas fa-robot text-indigo-600 mr-2"></i>
                Sistema de Aprendizado IA
            </h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4">
                    <h3 class="font-semibold text-indigo-800 mb-2">Buscas Aprendidas</h3>
                    <p id="learning-searches" class="text-2xl font-bold text-indigo-600">0</p>
                    <p class="text-sm text-indigo-600">Total de buscas no hist√≥rico</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">Sucessos</h3>
                    <p id="learning-successes" class="text-2xl font-bold text-green-600">0</p>
                    <p class="text-sm text-green-600">Buscas que encontraram empresas</p>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4">
                    <h3 class="font-semibold text-red-800 mb-2">Falhas</h3>
                    <p id="learning-failures" class="text-2xl font-bold text-red-600">0</p>
                    <p class="text-sm text-red-600">Buscas sem resultados</p>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="font-semibold text-gray-800 mb-2">Top Bairros (Aprendizado)</h3>
                <div id="top-learning-neighborhoods" class="flex flex-wrap gap-2">
                    <span class="text-gray-500">Carregando...</span>
                </div>
            </div>
        </div>

        <!-- Previous Searches -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-history text-blue-600 mr-2"></i>
                    Buscas Anteriores
                </h2>
                <button id="toggle-searches-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                    <i class="fas fa-eye mr-1"></i>Mostrar/Ocultar
                </button>
            </div>
            <div id="searches-container" class="space-y-2 max-h-64 overflow-y-auto hidden">
                <p class="text-gray-500 text-center py-4">Carregando buscas anteriores...</p>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-list text-green-600 mr-2"></i>
                    Empresas Encontradas
                </h2>
                <button id="load-more-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                    <i class="fas fa-plus mr-1"></i>Carregar Mais
                </button>
            </div>
            <div id="results-container" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center py-8">Nenhuma empresa encontrada ainda</p>
            </div>
            <div id="results-info" class="mt-4 text-sm text-gray-600 text-center">
                Mostrando <span id="results-shown">0</span> de <span id="results-total">0</span> empresas
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let currentSearchIndex = 0;
        let maxSearches = 10;
        let searchInterval = null;
        let currentOffset = 0;
        const resultsPerPage = 20;

        const elements = {
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            statusBadge: document.getElementById('status-badge'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            currentSearch: document.getElementById('current-search'),
            resultsContainer: document.getElementById('results-container'),
            maxSearchesInput: document.getElementById('max-searches'),
            statusMessages: document.getElementById('status-messages'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            resultsShown: document.getElementById('results-shown'),
            resultsTotal: document.getElementById('results-total'),
            statSuccessRate: document.getElementById('stat-success-rate'),
            learningSearches: document.getElementById('learning-searches'),
            learningSuccesses: document.getElementById('learning-successes'),
            learningFailures: document.getElementById('learning-failures'),
            topLearningNeighborhoods: document.getElementById('top-learning-neighborhoods'),
            toggleSearchesBtn: document.getElementById('toggle-searches-btn'),
            searchesContainer: document.getElementById('searches-container')
        };

        // Start prospecting
        elements.startBtn.addEventListener('click', startProspecting);
        elements.stopBtn.addEventListener('click', stopProspecting);
        elements.loadMoreBtn.addEventListener('click', loadMoreResults);
        elements.toggleSearchesBtn.addEventListener('click', toggleSearches);

        async function startProspecting() {
            if (isRunning) return;

            isRunning = true;
            currentSearchIndex = 0;
            maxSearches = parseInt(elements.maxSearchesInput.value);

            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;
            elements.statusBadge.className = 'px-3 py-1 bg-green-500 text-white rounded-full text-sm animate-pulse';
            elements.statusBadge.innerHTML = '<i class="fas fa-play"></i> Executando';

            performSearch();
        }

        function stopProspecting() {
            isRunning = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.statusBadge.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm';
            elements.statusBadge.innerHTML = '<i class="fas fa-pause"></i> Parado';
            addStatusMessage('Prospec√ß√£o parada pelo usu√°rio');
        }

        function addStatusMessage(message) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'text-xs';
            div.innerHTML = `<span class="text-gray-400">${time}:</span> ${message}`;
            elements.statusMessages.appendChild(div);
            elements.statusMessages.scrollTop = elements.statusMessages.scrollHeight;
        }

        async function performSearch() {
            if (!isRunning || currentSearchIndex >= maxSearches) {
                stopProspecting();
                updateProgress(maxSearches, maxSearches);
                loadResults();
                loadStats();
                return;
            }

            try {
                updateProgress(currentSearchIndex, maxSearches);

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        searchIndex: currentSearchIndex,
                        maxSearches: maxSearches
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const statusIcon = data.skipped ? 'üîÑ' : 'üîç';
                    const statusText = data.skipped ? 'Busca pulada (j√° realizada)' : data.searchTerm;

                    elements.currentSearch.innerHTML = `
                        <strong>${statusIcon} ${statusText}</strong><br>
                        <small class="text-gray-500">
                            ${data.neighborhood} ‚Ä¢ ${data.businessType} ‚Ä¢ ${data.resultsFound} resultados
                        </small>
                    `;

                    if (data.skipped) {
                        addStatusMessage(`Busca pulada: "${data.searchTerm}" j√° foi realizada anteriormente`);
                    } else {
                        addStatusMessage(`Encontrados ${data.resultsFound} resultados para "${data.searchTerm}"`);
                    }

                    if (data.resultsFound > 0) {
                        addResults(data.results);
                        addStatusMessage(`${data.resultsFound} empresas adicionadas √† lista`);
                    }

                    currentSearchIndex++;

                    if (isRunning && currentSearchIndex < maxSearches) {
                        addStatusMessage(`Aguardando 5 segundos para pr√≥xima busca...`);
                        setTimeout(performSearch, 5000); // 5s entre buscas
                    } else {
                        addStatusMessage('Prospec√ß√£o conclu√≠da!');
                        stopProspecting();
                        loadStats();
                        loadResults(); // Recarregar para mostrar buscas atualizadas
                    }
                } else {
                    console.error('Erro:', data.error);
                    addStatusMessage(`Erro na busca: ${data.error}`);
                    currentSearchIndex++;
                    if (isRunning) {
                        addStatusMessage('Tentando pr√≥xima busca em 5 segundos...');
                        setTimeout(performSearch, 5000);
                    }
                }

            } catch (error) {
                console.error('Erro na busca:', error);
                currentSearchIndex++;
                if (isRunning) setTimeout(performSearch, 5000);
            }
        }

        function updateProgress(current, total) {
            const percent = total > 0 ? (current / total) * 100 : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${Math.round(percent)}%`;
            elements.progressText.textContent = `${current}/${total} buscas`;
        }

        function addResults(results, append = false) {
            if (!append && elements.resultsContainer.querySelector('p.text-gray-500')) {
                elements.resultsContainer.innerHTML = '';
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition-colors border-l-4 border-green-500';
                const foundDate = result.foundAt ? new Date(result.foundAt).toLocaleDateString('pt-BR') : 'N/A';
                const searchTerm = result.searchTerm || 'N/A';
                const neighborhood = result.neighborhood || 'N/A';
                const businessType = result.businessType || 'N/A';

                div.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-semibold text-gray-800 flex-1">${result.title}</h3>
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">${foundDate}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-2">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${neighborhood}</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded mr-1">${businessType}</span>
                        <span class="text-gray-500">‚Ä¢ ${searchTerm}</span>
                    </div>
                    <a href="${result.url}" target="_blank" class="text-blue-600 text-sm hover:underline block mb-2">
                        ${result.url.length > 60 ? result.url.substring(0, 60) + '...' : result.url}
                    </a>
                    <p class="text-gray-600 text-sm">${result.description ? result.description.substring(0, 150) + '...' : 'Sem descri√ß√£o'}</p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="analyzeCompany('${result.url.replace(/'/g, "\\'")}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded hover:bg-indigo-600 transition-colors">
                            <i class="fas fa-brain mr-1"></i>Analisar IA
                        </button>
                        <button onclick="openCompany('${result.url}')" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600 transition-colors">
                            <i class="fas fa-external-link-alt mr-1"></i>Visitar
                        </button>
                    </div>
                `;
                if (append) {
                    elements.resultsContainer.appendChild(div);
                } else {
                    elements.resultsContainer.insertBefore(div, elements.resultsContainer.firstChild);
                }
            });
        }

        function loadMoreResults() {
            currentOffset += resultsPerPage;
            loadResults(true);
        }

        function openCompany(url) {
            window.open(url, '_blank');
        }

        async function analyzeCompany(url) {
            if (confirm('Deseja analisar esta empresa com IA? Isso pode levar alguns segundos.')) {
                // Encontrar o ID da empresa
                const companyId = btoa(url).substring(0, 50);
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'analyze_company_deep',
                            companyId: companyId
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('An√°lise conclu√≠da! Verifique os detalhes da empresa.');
                        loadResults(); // Recarregar para mostrar an√°lise
                    } else {
                        alert('Erro na an√°lise: ' + data.error);
                    }
                } catch (error) {
                    alert('Erro ao analisar empresa: ' + error.message);
                }
            }
        }

        async function loadResults(append = false) {
            try {
                const limit = append ? resultsPerPage : 50;
                const offset = append ? currentOffset : 0;
                const response = await fetch(`/api/results?limit=${limit}&offset=${offset}&includeSearches=true`);
                const data = await response.json();

                if (data.success) {
                    if (data.results.length > 0) {
                        addResults(data.results, append);
                    }

                    elements.resultsTotal.textContent = data.total;
                    elements.resultsShown.textContent = append ?
                        Math.min(currentOffset + data.results.length, data.total) :
                        Math.min(data.results.length, data.total);

                    elements.loadMoreBtn.style.display = data.pagination.hasMore ? 'block' : 'none';

                    // Carregar buscas anteriores
                    if (data.previousSearches) {
                        loadPreviousSearches(data.previousSearches);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar resultados:', error);
            }
        }

        function toggleSearches() {
            const isHidden = elements.searchesContainer.classList.contains('hidden');
            if (isHidden) {
                elements.searchesContainer.classList.remove('hidden');
                elements.toggleSearchesBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Ocultar';
            } else {
                elements.searchesContainer.classList.add('hidden');
                elements.toggleSearchesBtn.innerHTML = '<i class="fas fa-eye mr-1"></i>Mostrar';
            }
        }

        function loadPreviousSearches(searches) {
            if (searches.length === 0) {
                elements.searchesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma busca anterior encontrada</p>';
                return;
            }

            elements.searchesContainer.innerHTML = '';

            searches.forEach(search => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg border-l-4 border-blue-500';
                const completedDate = search.completedAt ? new Date(search.completedAt).toLocaleDateString('pt-BR') : 'N/A';

                div.innerHTML = `
                    <div class="flex items-start justify-between mb-1">
                        <h4 class="font-semibold text-gray-800 text-sm">${search.searchTerm}</h4>
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">${completedDate}</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${search.neighborhood}</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded mr-1">${search.businessType}</span>
                        <span class="text-gray-500">‚Ä¢ ${search.resultsCount} resultados</span>
                    </div>
                `;

                elements.searchesContainer.appendChild(div);
            });
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-companies').textContent = data.general.uniqueCompanies;
                    document.getElementById('stat-searches').textContent = data.general.totalSearches;
                    document.getElementById('stat-average').textContent = data.general.averagePerSearch;
                    document.getElementById('stat-success-rate').textContent = data.learning.successRate;
                    document.getElementById('learning-searches').textContent = data.learning.totalLearningSearches;
                    document.getElementById('learning-successes').textContent = data.learning.successfulSearches;
                    document.getElementById('learning-failures').textContent = data.learning.failedSearches;

                    // Top bairros do aprendizado
                    const neighborhoodsHtml = data.learning.topNeighborhoods.map(n =>
                        `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">${n.name} (${n.score})</span>`
                    ).join(' ');
                    elements.topLearningNeighborhoods.innerHTML = neighborhoodsHtml || '<span class="text-gray-500 text-xs">Nenhum dado ainda</span>';
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        // Load initial data
        loadResults();
        loadStats();

        // Auto-refresh stats
        setInterval(loadStats, 30000);
    </script>
</body>
</html>