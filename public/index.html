<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prospec√ß√£o Inteligente - Fortaleza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 min-h-screen">
    <!-- Header -->
    <nav class="bg-white/95 backdrop-blur-sm shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-search-dollar text-purple-600 mr-2"></i>
                    Prospec√ß√£o Fortaleza
                </h1>
                <div class="flex gap-2">
                    <span id="status-badge" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                        <i class="fas fa-pause"></i> Parado
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Controls -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sliders text-purple-600 mr-2"></i>
                        Controles
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                N√∫mero de buscas
                            </label>
                            <input type="number" id="max-searches" value="10" min="1" max="50"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div class="flex gap-3">
                            <button id="start-btn" 
                                class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition-all">
                                <i class="fas fa-play mr-2"></i>Iniciar Prospec√ß√£o
                            </button>
                            <button id="stop-btn" disabled
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-stop mr-2"></i>Parar
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Progresso
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                <span id="progress-text">Pronto para iniciar</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div id="progress-bar" 
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 h-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="current-search" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                            Aguardando in√≠cio...
                        </div>
                        <div id="status-messages" class="text-xs text-gray-500 mt-2 space-y-1 max-h-20 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Empresas</p>
                        <p id="stat-companies" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-building text-4xl text-purple-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Buscas</p>
                        <p id="stat-searches" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-search text-4xl text-blue-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">M√©dia/Busca</p>
                        <p id="stat-average" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-chart-pie text-4xl text-green-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm">Resultados</p>
                        <p id="stat-results" class="text-3xl font-bold">0</p>
                    </div>
                    <i class="fas fa-trophy text-4xl text-orange-200"></i>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">
                <i class="fas fa-list text-green-600 mr-2"></i>
                Empresas Encontradas
            </h2>
            <div id="results-container" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center py-8">Nenhuma empresa encontrada ainda</p>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let currentSearchIndex = 0;
        let maxSearches = 10;
        let searchInterval = null;

        const elements = {
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            statusBadge: document.getElementById('status-badge'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            currentSearch: document.getElementById('current-search'),
            resultsContainer: document.getElementById('results-container'),
            maxSearchesInput: document.getElementById('max-searches'),
            statusMessages: document.getElementById('status-messages')
        };

        // Start prospecting
        elements.startBtn.addEventListener('click', startProspecting);
        elements.stopBtn.addEventListener('click', stopProspecting);

        async function startProspecting() {
            if (isRunning) return;

            isRunning = true;
            currentSearchIndex = 0;
            maxSearches = parseInt(elements.maxSearchesInput.value);

            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;
            elements.statusBadge.className = 'px-3 py-1 bg-green-500 text-white rounded-full text-sm animate-pulse';
            elements.statusBadge.innerHTML = '<i class="fas fa-play"></i> Executando';

            performSearch();
        }

        function stopProspecting() {
            isRunning = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.statusBadge.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm';
            elements.statusBadge.innerHTML = '<i class="fas fa-pause"></i> Parado';
            addStatusMessage('Prospec√ß√£o parada pelo usu√°rio');
        }

        function addStatusMessage(message) {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'text-xs';
            div.innerHTML = `<span class="text-gray-400">${time}:</span> ${message}`;
            elements.statusMessages.appendChild(div);
            elements.statusMessages.scrollTop = elements.statusMessages.scrollHeight;
        }

        async function performSearch() {
            if (!isRunning || currentSearchIndex >= maxSearches) {
                stopProspecting();
                updateProgress(maxSearches, maxSearches);
                loadResults();
                loadStats();
                return;
            }

            try {
                updateProgress(currentSearchIndex, maxSearches);

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        searchIndex: currentSearchIndex,
                        maxSearches: maxSearches
                    })
                });

                const data = await response.json();

                if (data.success) {
                    elements.currentSearch.innerHTML = `
                        <strong>üîç ${data.searchTerm}</strong><br>
                        <small class="text-gray-500">
                            ${data.neighborhood} ‚Ä¢ ${data.businessType} ‚Ä¢ ${data.resultsFound} resultados
                        </small>
                    `;

                    addStatusMessage(`Encontrados ${data.resultsFound} resultados para "${data.searchTerm}"`);

                    if (data.resultsFound > 0) {
                        addResults(data.results);
                        addStatusMessage(`${data.resultsFound} empresas adicionadas √† lista`);
                    }

                    currentSearchIndex++;

                    if (isRunning && currentSearchIndex < maxSearches) {
                        addStatusMessage(`Aguardando 5 segundos para pr√≥xima busca...`);
                        setTimeout(performSearch, 5000); // 5s entre buscas
                    } else {
                        addStatusMessage('Prospec√ß√£o conclu√≠da!');
                        stopProspecting();
                        loadStats();
                    }
                } else {
                    console.error('Erro:', data.error);
                    addStatusMessage(`Erro na busca: ${data.error}`);
                    currentSearchIndex++;
                    if (isRunning) {
                        addStatusMessage('Tentando pr√≥xima busca em 5 segundos...');
                        setTimeout(performSearch, 5000);
                    }
                }

            } catch (error) {
                console.error('Erro na busca:', error);
                currentSearchIndex++;
                if (isRunning) setTimeout(performSearch, 5000);
            }
        }

        function updateProgress(current, total) {
            const percent = total > 0 ? (current / total) * 100 : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${Math.round(percent)}%`;
            elements.progressText.textContent = `${current}/${total} buscas`;
        }

        function addResults(results) {
            if (elements.resultsContainer.querySelector('p.text-gray-500')) {
                elements.resultsContainer.innerHTML = '';
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition-colors';
                div.innerHTML = `
                    <h3 class="font-semibold text-gray-800 mb-1">${result.title}</h3>
                    <a href="${result.url}" target="_blank" class="text-blue-600 text-sm hover:underline">
                        ${result.url}
                    </a>
                    <p class="text-gray-600 text-sm mt-2">${result.description.substring(0, 150)}...</p>
                `;
                elements.resultsContainer.insertBefore(div, elements.resultsContainer.firstChild);
            });
        }

        async function loadResults() {
            try {
                const response = await fetch('/api/results?limit=20');
                const data = await response.json();

                if (data.success && data.results.length > 0) {
                    elements.resultsContainer.innerHTML = '';
                    addResults(data.results);
                }
            } catch (error) {
                console.error('Erro ao carregar resultados:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('stat-companies').textContent = data.general.uniqueCompanies;
                    document.getElementById('stat-searches').textContent = data.general.totalSearches;
                    document.getElementById('stat-average').textContent = data.general.averagePerSearch;
                    document.getElementById('stat-results').textContent = data.general.totalResults;
                }
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        // Load initial data
        loadResults();
        loadStats();

        // Auto-refresh stats
        setInterval(loadStats, 30000);
    </script>
</body>
</html>